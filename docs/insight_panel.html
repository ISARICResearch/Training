<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create your own insight panel in VERTEX</title>
    <style>
        body {
            display: flex;
            font-family: Arial, sans-serif;
            margin: 0;
            overflow-x: hidden;
        }
        .sidebar {
            width: 250px;
            background-color: #f4f4f4;
            padding: 15px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            height: 100vh;
            position: fixed;
            overflow-y: auto;
        }
        .content {
            margin-left: 270px;
            padding: 20px;
            max-width: 900px;
        }
        .content h1, .content h2, .content h3 {
            margin-top: 40px;
        }
        .content p, .content img {
            max-width: 100%;
        }
        pre {
            background-color: #2d2d2d;
            color: #f8f8f2;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
        code {
            color: #f8f8f2;
        }
        .sidebar a {
            display: block;
            padding: 10px;
            color: #333;
            text-decoration: none;
            margin-bottom: 5px;
            border-radius: 5px;
        }
        .sidebar a:hover {
            background-color: #ddd;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2><a href="https://isaricresearch.github.io/Training/">Home</a></h2>
        <div style="padding-left:10px">
		<h2>Contents</h2>
	        <a href="#introduction">Introduction</a>
	        <a href="#raps">Reproducible analytical pipelines</a>
		<a href="#cloning_vertex">Insight panels</a>
		<a href="#vertex_functions">Insight panels</a>
		</div>
    </div>
    <div class="content">
        <h1 id="introduction">Introduction</h1>
        <p>VERTEX (Visual Evidence & Research Tool for Exploration) is a web-based application that presents graphs and tables relating to research questions that need to be quickly answered during an outbreak.</p>

	<video loop controls autoplay muted>
	  <source src="https://github.com/ISARICResearch/Training/raw/main/docs/assets/vertex.mp4" type="video/mp4">
	</video>
	    
	<p>VERTEX is built using blocks of code, which we call <strong>reproducible analytical pipelines</strong> (RAPs). RAPs are used to create visualisations, graphs and tables, each of which we call an <strong>insight</strong>. Insights are grouped together in an <strong>insight panel</strong> to provide information about one study endpoint relating to a particular research question.</p>
	    
	<p>At the moment, we have insight panels for the following research questions:
	<ul>
        <li>What are the characteristics and clinical presentation of patients with ... at hospital admission?</li>
	    <li>What are the outcomes within ... days of presentation, and what are the risk factors associated with these outcomes?</li>
	    <li>What treatments are administered to patients with ... during their observation period?</li>
	</ul>
	New questions will be added by the ISARIC team and the wider scientific community, enabling the creation and sharing of new RAPs and insight panels.</p>
	
	<p>This guide will help you to create a new insight panel. These are practical instructions for how to adapt the VERTEX code only. Before you start, you should consider how you want to present or the model the data, and how to visualise this information conceptually.</p>

<!--         <h3 id="characterization"><em>Characterization</em></h3>
        <p>This section contains different graphs including:</p>
        <ul>
            <li>Descriptive Table containing count of each variable</li>
            <li>Dual-sided stacked pyramid contrasting outcomes within age and sex</li>
            <li>Horizontal bar graph demonstrating proportions of signs and symptoms in the patient population</li>
            <li>UpSet plot to visualize interacting sets of data. The five most common signs or symptoms in a dataset are seen here, with the series of dots showing which symptoms are included in each intersection.</li>
            <li>Heatmap with dendrogram to compare the frequency of co-morbidities and symptoms while clustering variables based on similarity in their distribution</li>
        </ul> -->

        <h2 id="raps">Reproducible analytical pipelines</h2>
        
	<p>Reproducible analytical pipelines (RAPs) are built using small reusable modular blocks of code. These blocks of code process the database into an analysis-ready dataframe relating a particular endpoint of a relevant research question. This dataframe is then visualised as a table or figure.</p>

	<img src="https://github.com/ISARICResearch/Training/raw/main/docs/assets/12_reusable.png" alt="RAP">
		
	<p>RAPs automate the process of data analysis ensuring results are consistent, transparent, and reproducible. They can be reused across different analyses with easy adjustments without modifying the core code.</p>

<!--         <h2 id="Step 1">Step 1: Identifying suitable graphical representations</h2>
        <p>The first step is determining which graphs would best represent the information that is being presented. To do this, we explored existing publications and examined the figures utilised that would be applicable in our scenario focusing upon treatments. </p>

        <p>We identified heatmaps that illustrated relationships between treatments & complications / co-morbidities. We also identified violin plots to visualise the distribution of treatment types amongst sex and age. Finally, we found a cumulative frequency graph useful to demonstrate all types of treatments over an outbreak period. </p>

        <img src="https://github.com/ISARICResearch/Training/raw/main/docs/assets/13_graphs.png" alt="graphs">

        <p> For each graph, we identified which variables would be used as inputs referencing the ARC database and the data dictionary. With this we created fake data for the purpose of confidentiality during testing replicating the format of the data template. </p>

        <a href="https://github.com/ISARICResearch/Training/raw/main/docs/assets/dengue_data_dictionary.csv" download>Data dictionary</a>
        <br>
        <a href="https://github.com/ISARICResearch/Training/raw/main/docs/assets/60_Dengue_Fake_Patient_v2.csv" download>Fake Data</a> -->

	<h2 id="cloning_vertex">Cloning VERTEX and getting started</h2>

	<p>For this guide, you will need your own local copy of VERTEX. If you have not already done so, please follow the VERTEX starting guide: <a href="https://isaricresearch.github.io/Training/vertex_starting">https://isaricresearch.github.io/Training/vertex_starting</a>.</p>

	<h2 id="vertex_functions">VERTEX main functions</h2>

	<p>The core scripts in VERTEX are:
	<ul>
            <li>getREDCapData.py: this imports data from a REDCap project via an API token, gets the data type for each variable and reformats the dataframe</li>
	    <li>IsaricAnalytics.py: this contains reusable modular blocks of code used in the standard RAPs, e.g. converting data to the same units, imputing missing data, fitting models</li>
	    <li>IsaricDraw.py: this contains functions for converting dataframes into insights e.g. visualisations, tables and figures</li>
	    <li>descriptive_dashboard.py: this is the main function for the web-based application, which runs the dashboard and defines what happens when the user interacts with the dashboard</li>
	</ul></p>

	<p>Other .py functions are specific to each research question, and consist of the main code for one or more insight panels. In order to create a new insight panel for an existing research question, you will need to add to one of these scripts. In order to create an insight panel for a new research question, you will need to create a new script.</p>

	<p>In the process of creating a new insight panel, you will need to modify the core scripts in specific places. These are described below and highlighted with comments within the code.</p>
        
<!--         <h3 id="reusable-modules">Step 2: Creating reusable modules</h3>
        <p>VERTEX uses Plotly, a sub-library from Dash. A library of graphics available can be found at <a href="https://plotly.com/python/">https://plotly.com/python/</a>. This also assists in providing examples of the code required to create a graph & customise the graph to your specifications.</p>

        <p>Next, to incorporate these into VERTEX, create a function containing the plot you have coded in IsaricDraw.py. <br> IsaricDraw.py contains a collection of functions which are called upon in RAP sections (e.g. Characterization, Risk / Prognosis). An example is shown below. The parameters included allow the graph to be customised for different variable sets, titles and labels. </p>
       
        <pre><code>def violin_plot (datao, vio_bin, vio_cont, num_graphs, title, graph_id):</code></pre>
       
        <h3 id="Step 3">Step 3: Creating your own panel</h3>
        <p> Before starting, we need to create a space for the section to go. In IsaricDraw.py, under the define_menu function:</p>
        
        <p>1.Create a button renaming variable 1 (‘Treatment’) and variable 5 (“treatx”):</p>
        <pre><code>treatmentx_btn=dbc.Button("Treatment" id={"type": "open-modal" "index": "treatx"} className="mb-2" style={'width': '100%'})<br>generic_btn=dbc.Button("Treatment", id={"type": "open-modal", "index": "treatx"}, className="mb-2", style={'width': '100%'})</code></pre>

        <p>2. Link a new panel to this button and the existing modal:</p>
        <pre><code>treatment_children=[treatmentx_btninitial_modal]<br>generic_children = [generic_btn initial_modal]</code></pre>
        
        <p>Add an accordion item similar to:</p>
        <pre><code>dbc.AccordionItem(<br>&emsp;title="Interventions",<br>&emsp;children=treatment_children <br>)</code></pre>
        <p> You should now have your own panel similar to: </p>
        <img src="https://github.com/ISARICResearch/Training/raw/main/docs/assets/15_panel.png" alt="panel">

        <h3 id="Generic.py"><em>Creating a New File</em></h3>
        <p>Generic.py is a template created to use as a starting point for creating your own section. This file contains step by step, in code instructions to direct you to the specific lines referred to. We would recommend you create your own file and copy and paste all the info from Generic.py </p>

        <h3 id="Step 4">Step 4: Creating instructions for your section</h3>
        <p> At the beginning of the create_modal function is the opportunity to specify your instructions for how the RAP should be utilised. The linegraph_instructions and linegraph_about can be altered according to your needs. </p>
        <pre><code>def create_modal():
	linegraph_instructions = html.Div([
		html.Div("1. Select/remove countries using the dropdown (type directly into the dropdowns to search faster)"),
		html.Br(),
		html.Div("2. Change datasets using the dropdown (country selections are remembered)"),
	</code></pre>
        
        <h3 id="Step 5">Step 5: Adapting the Descriptive Table to display your desired information</h3>
        <p>In this example we only wanted to see data relating to treatments so specified this with the following code</p>
        <pre><code>
	variables_binary=[var for var in variables_binary if var.startswith('inter_')]
		</code></pre>

        <h3 id="Step 6">Step 6: Specifying the parameters for your functions from IsaricDraw.py</h3>
        <p> There is a wide variety of plots already available, in addition to the specific graphs you may have created in section 2. We will continue to use the Violin Plot as an example. Define each parameter for the remaining graphs.</p>
        <pre><code>
	vio_bin = 'slider_sex'
	vio_cont = 'age'
	demog_columns = [vio_bin, vio_cont]
	df11 = df_map[list(treatx_columns) + (demog_columns)]
	violin_plot = idw.violin_plot(df11, vio_bin, vio_cont, 5, 'Age Distribution of Treatments by Sex', graph_id="treatx_ViolinPlot2")
	</code></pre>

        <h3 id="Step 7">Step 7: Finishing the modal</h3>
        <p> Change the name of the button in the header in addition to adding your functions (with specified parameters). Give each function a unique name </p>
        <pre><code>
	dbc.Tab(dbc.Row([dbc.Col([fig_table_treatx],id='table_treatx')]), label='1.Descriptive table'),
	dbc.Tab(dbc.Row([dbc.Col(freq_chart_treatx,id='freqTreatx_chart')]), label='2.Frequency of Treatments Utilised'),
	dbc.Tab(dbc.Row([dbc.Col(upset_plot_treatx,id='upsetTreatx_chart')]), label='3.Intersections of Treatments'),
	</code></pre>

        <h3 id="finishing-modal">Step 8: Specifics</h3>
        <p>Specify the unique names used for your plots to callback when the button is clicked in Output </p>
        <pre><code>
	Output('freqTreatx_chart', 'children'),
	Output('upsetTreatx_chart', 'children'),
	</code></pre>
	
        <p> Additionally, we need to provide instructions for when filters and controls are applied to call from an updated dataframe</p>
        <pre><code>
	treatx_Heatmap1 = idw.heatmap(filtered_df, title="Heatmap comparing Frequency of Symptoms and Treatments", graph_id="treatx_Heatmap1")
	</code></pre>

        <h3 id="additional-steps">Step 9: Update corresponding files in <descriptive_dashboard class="py"></descriptive_dashboard></h3>
        <p>Add instructions to check if a button has been clicked and open the modal.</p>
        <pre><code>
	elif button_id =='{"index":"treatx","type":"open-modal"}':
		return not is_open, treatx.create_modal()
	</code></pre> -->
